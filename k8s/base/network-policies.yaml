# Default deny all ingress traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: ereuna-prod
spec:
  podSelector: {}
  policyTypes:
  - Ingress
---
# Allow frontend to be accessed from ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-ingress
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3500
---
# Allow backend to receive from frontend (if internal calls exist)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-allow-internal
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    - podSelector:
        matchLabels:
          app: websocket
    - podSelector:
        matchLabels:
          app: aggregator
    - podSelector:
        matchLabels:
          app: ingestor
    - namespaceSelector:
        matchLabels:
          name: ereuna-monitoring
    ports:
    - protocol: TCP
      port: 5500
---
# Allow WebSocket to be accessed from ingress and internal services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: websocket-allow-traffic
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: websocket
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 8000
---
# Allow MongoDB to be accessed only by application pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-allow-internal
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: backend
    - podSelector:
        matchLabels:
          app: websocket
    - podSelector:
        matchLabels:
          app: aggregator
    - podSelector:
        matchLabels:
          app: ingestor
    - podSelector:
        matchLabels:
          app: mongodb-exporter
    ports:
    - protocol: TCP
      port: 27017
---
# Allow Redis to be accessed only by application pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-allow-internal
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: backend
    - podSelector:
        matchLabels:
          app: websocket
    - podSelector:
        matchLabels:
          app: aggregator
    - podSelector:
        matchLabels:
          app: ingestor
    - podSelector:
        matchLabels:
          app: redis-exporter
    ports:
    - protocol: TCP
      port: 6379
---
# Allow Prometheus to scrape metrics from all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: ereuna-prod
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ereuna-monitoring
      podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 5500  # backend metrics
    - protocol: TCP
      port: 8000  # websocket metrics
    - protocol: TCP
      port: 8001  # ingestor metrics
    - protocol: TCP
      port: 8002  # aggregator metrics
    - protocol: TCP
      port: 9216  # mongodb-exporter
    - protocol: TCP
      port: 9121  # redis-exporter
---
# Allow aggregator and ingestor to communicate
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: aggregator-allow-internal
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: aggregator
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: ingestor
    - namespaceSelector:
        matchLabels:
          name: ereuna-monitoring
    ports:
    - protocol: TCP
      port: 8002
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ingestor-allow-internal
  namespace: ereuna-prod
spec:
  podSelector:
    matchLabels:
      app: ingestor
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: aggregator
    - namespaceSelector:
        matchLabels:
          name: ereuna-monitoring
    ports:
    - protocol: TCP
      port: 8001
---
# Allow all egress traffic (pods can call external APIs)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-egress
  namespace: ereuna-prod
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - {}
---
# Monitoring namespace policies
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-ingress
  namespace: ereuna-monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ereuna-prod
    - namespaceSelector:
        matchLabels:
          name: ereuna-monitoring
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-egress
  namespace: ereuna-monitoring
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - {}

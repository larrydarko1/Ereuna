# IMPORTANT: This requires cert-manager to be installed in the cluster
# Install cert-manager first:
# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# Then create a Cloudflare API token secret:
# kubectl create secret generic cloudflare-api-token \
#   --from-literal=api-token=YOUR_CLOUDFLARE_API_TOKEN \
#   -n cert-manager

---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com  # REPLACE with your email
    privateKeySecretRef:
      name: letsencrypt-prod-key
    solvers:
    - dns01:
        cloudflare:
          email: admin@example.com  # REPLACE with your email
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ereuna-ingress
  namespace: ereuna-prod
  annotations:
    # cert-manager annotation to automatically create TLS certificates
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=(), interest-cohort=()";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com https://api.tiingo.com wss://api.tiingo.com https://ereuna.io wss://ereuna.io; frame-src https://js.stripe.com https://hooks.stripe.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; object-src 'none'";
    
    # Enable compression
    nginx.ingress.kubernetes.io/enable-compression: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    
    # WebSocket support
    nginx.ingress.kubernetes.io/websocket-services: "websocket"
    
    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - ereuna.io
    - www.ereuna.io
    secretName: ereuna-tls-cert
  rules:
  - host: ereuna.io
    http:
      paths:
      # WebSocket endpoint - must come first for proper routing
      - path: /ws
        pathType: Prefix
        backend:
          service:
            name: websocket
            port:
              number: 8000
      # Frontend - catch all other routes
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3500
  - host: www.ereuna.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3500
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: ereuna-monitoring
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - grafana.ereuna.io
    secretName: grafana-tls-cert
  rules:
  - host: grafana.ereuna.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
